# PandaWiki 本地开发启动问题解决指南

## 概述

本文档记录了在本地环境启动PandaWiki项目时遇到的常见问题及其解决方案。适用于从服务器部署环境复制代码到本地进行开发的场景。

## 环境背景

- **服务器环境**: 完整的Docker容器部署
- **本地环境**: 源码开发，连接服务器中间件服务
- **服务器IP**: 10.211.55.9
- **开发模式**: 前端+后端本地运行，数据库等中间件使用服务器服务

## 问题清单与解决方案

### 1. Go环境问题

#### 问题现象
```bash
$ go run cmd/api/main.go
# command-line-arguments
cmd/api/main.go:18:14: undefined: createApp
```

#### 原因分析
- Go未安装或未添加到PATH
- wire代码生成文件缺失

#### 解决方案
```bash
# 1. 安装Go (如果未安装)
brew install go
# 或者手动下载安装

# 2. 验证Go安装
go version

# 3. 重新生成wire代码
cd backend
go mod tidy
go generate ./...
```

### 2. 容器网络连接问题

#### 问题现象
```bash
dial tcp: lookup panda-wiki-redis on 127.0.0.53:53: no such host
```

#### 原因分析
配置文件中使用了Docker容器名（如`panda-wiki-redis`），本地环境无法解析这些容器名。

#### 解决方案
修改 `backend/config/config.go` 中的默认配置，将容器名替换为服务器IP：

```go
// 修改前
Redis: RedisConfig{
    Addr:     "panda-wiki-redis:6379",
    Password: "",
},

// 修改后  
Redis: RedisConfig{
    Addr:     "10.211.55.9:6379",
    Password: "pzgAhJ9yf3Ep3Cm0AzeJtz7VrJWUKVUZ",
},
```

**需要修改的服务**:
- PostgreSQL: `panda-wiki-postgres` → `10.211.55.9`
- Redis: `panda-wiki-redis` → `10.211.55.9`
- MinIO: `panda-wiki-minio` → `10.211.55.9`
- NATS: 容器名 → `10.211.55.9`
- Qdrant: 容器名 → `10.211.55.9`

### 3. 数据库迁移版本冲突

#### 问题现象
```bash
error="Dirty database version 21. Fix and force version."
```

#### 原因分析
本地代码的迁移文件版本与服务器数据库版本不匹配。

#### 解决方案
在 `backend/store/pg/pg.go` 中跳过数据库迁移：

```go
// 注释掉迁移调用
// if err := doMigrate(dsn); err != nil {
//     return nil, err
// }

// 添加注释说明
// 本地开发时跳过数据库迁移，因为连接的是已经迁移好的服务器数据库
```

### 4. 文件路径权限问题

#### 问题现象
```bash
mkdir /data: permission denied
```

#### 原因分析
代码中使用了绝对路径（如`/data`），本地环境没有权限创建。

#### 解决方案

**修改telemetry路径** (`backend/telemetry/client.go`):
```go
const (
    machineIDFile  = "./data/.machine_id" // 改为相对路径
    reportInterval = time.Hour
)
```

**修改SSL证书路径** (`backend/setup/cert.go`):
```go
const (
    keyFile  = "./data/ssl/panda-wiki.key"  // 改为相对路径
    certFile = "./data/ssl/panda-wiki.crt"  // 改为相对路径
)

// 修改目录创建逻辑
if err := os.MkdirAll("./data/ssl", 0o755); err != nil {
    return fmt.Errorf("failed to create ssl dir: %v", err)
}
```

**创建必要目录**:
```bash
cd backend
mkdir -p data/ssl
```

### 5. Caddy服务依赖问题

#### 问题现象
```bash
failed to sync kb access settings to caddy: failed to send request: Post "http://unix/config/": dial unix: missing address
```

#### 原因分析
- 本地环境没有Caddy服务
- 创建知识库时尝试同步配置到Caddy失败

#### Caddy的作用
- **多端口访问**: 每个知识库可配置独立端口（8001、8002等）
- **域名绑定**: 支持自定义域名访问
- **动态路由**: 自动配置反向代理规则
- **SSL管理**: 处理HTTPS证书

#### 解决方案
修改 `backend/repo/pg/knowledge_base.go`，在本地开发时跳过Caddy同步：

```go
// 原代码
if err := r.SyncKBAccessSettingsToCaddy(ctx, kbs); err != nil {
    r.logger.Error("failed to sync kb access settings to caddy", "error", err)
    return err
}

// 修改后
if r.config.CaddyAPI != "" {
    if err := r.SyncKBAccessSettingsToCaddy(ctx, kbs); err != nil {
        r.logger.Error("failed to sync kb access settings to caddy", "error", err)
        return err
    }
} else {
    r.logger.Info("Caddy API disabled, skipping sync")
}
```

### 6. License接口404问题

#### 问题现象
```bash
GET /api/v1/license status=404
```

#### 原因分析
License handler未实现，前端调用时返回404。

#### 解决方案
**方案A**: 前端注释license调用（推荐）

修改 `web/admin/src/App.tsx`:
```typescript
useEffect(() => {
  if (token) {
    // 临时注释掉license接口调用
    // getApiV1License().then(res => {
    //   dispatch(setLicense(res));
    // });
    
    // 设置默认免费版license
    dispatch(setLicense({
      edition: 0, // 免费版
      state: 1,   // 有效状态
      started_at: 0,
      expired_at: 0
    }));
  }
}, [token]);
```

**方案B**: 实现License handler（可选）

### 9. 用户前台KB_ID获取问题

#### 问题现象
```bash
response error: {
  data: {
    message: 'kb_id is required [trace_id: xxx]',
    success: false
  },
  url: 'http://localhost:8000/share/v1/app/web/info'
}
Error: NEXT_REDIRECT at redirect("/auth/login")
```

#### 原因分析
- 用户前台需要通过 `X-KB-ID` header 获取知识库信息
- 本地开发环境缺少Caddy服务的自动Header注入
- 前端调用share接口时缺少必需的KB_ID参数

#### PandaWiki中KB_ID的正常获取逻辑

**核心机制**: Caddy动态路由 + Header自动注入

1. **知识库访问方式配置**:
   ```
   端口访问: http://server:8001 → KB_ID: uuid-a
   域名访问: https://wiki-a.company.com → KB_ID: uuid-a
   SSL端口: https://server:8443 → KB_ID: uuid-a
   ```

2. **Caddy自动Header注入**:
   ```json
   {
     "handler": "headers",
     "request": {
       "set": {"X-KB-ID": ["kb-uuid-a"]}
     }
   }
   ```

3. **完整请求流程**:
   ```
   用户访问域名/端口 → Caddy识别并注入X-KB-ID →
   转发到前端应用 → 前端转发API请求(带Header) →
   后端读取Header获取KB_ID → 返回对应知识库数据
   ```

#### 解决方案

**方案A**: 跳过KB信息获取（推荐用于本地开发）

修改 `web/app/src/app/layout.tsx`:
```typescript
export async function generateMetadata(): Promise<Metadata> {
  // 本地开发时跳过KB信息获取，使用默认值
  let kbDetail: any = null;
  try {
    kbDetail = await getShareV1AppWebInfo();
  } catch (error) {
    console.log('Failed to get KB info, using defaults for local development');
  }
  // 返回默认配置...
}
```

修改 `web/app/src/request/httpClient.ts`:
```typescript
const pathnameWhiteList = ["/auth/login", "/welcome", "/"];
```

**方案B**: 环境变量指定KB_ID（可选）

1. 通过管理后台创建测试知识库，获取KB_ID
2. 在 `web/app/.env.local` 中设置:
   ```bash
   DEV_KB_ID=your-kb-id-here
   ```
3. 前端中间件会自动使用此KB_ID

#### 功能影响

**✅ 方案A适用场景**:
- 界面开发和调试
- 组件功能测试
- 样式和主题调整
- 基础功能验证

**⚠️ 功能限制**:
- 无法测试多知识库功能
- 需要认证的功能受限
- 无法测试域名绑定功能

### 7. 前端端口配置问题

#### 问题现象
前端无法连接到后端API。

#### 原因分析
后端API运行在端口8000，但前端配置指向8080。

#### 解决方案
更新前端环境变量：

**管理后台** (`web/admin/.env.local`):
```bash
VITE_API_BASE_URL=http://localhost:8000
TARGET=http://localhost:8000
STATIC_FILE_TARGET=http://localhost:8000
SHARE_TARGET=http://localhost:8000
```

**用户前台** (`web/app/.env.local`):
```bash
NEXT_PUBLIC_API_BASE_URL=http://localhost:8000
TARGET=http://localhost:8000
STATIC_FILE_TARGET=http://localhost:8000
```

### 8. Crawler爬虫服务连接问题

#### 问题现象
```bash
POST /api/v1/crawler/scrape 报错
error="Post \"http://panda-wiki-crawler:8080/api/v1/scrape\": dial tcp: lookup panda-wiki-crawler: no such host"
```

#### 原因分析
- 爬虫服务URL硬编码了容器名 `panda-wiki-crawler`
- 本地环境无法解析Docker容器名
- 静态文件路径也使用了容器名

#### Crawler服务的作用
- **网页内容抓取**: 将网页URL转换为Markdown格式文档
- **文档导入**: 支持从URL批量导入文档到知识库
- **格式转换**: 自动提取网页标题和正文内容
- **文件处理**: 处理上传文件并转换为可读格式

#### 解决方案

**方案A**: 启动本地Crawler服务（推荐）

1. **启动本地Crawler服务**:
   ```bash
   cd backend
   go run cmd/crawler/main.go
   ```

2. **修改crawler服务地址**为本地地址：
   ```go
   // 修改 backend/usecase/crawler.go
   func (u *CrawlerUsecase) ScrapeURL(ctx context.Context, targetURL string, kbID string) (*domain.ScrapeResp, error) {
       // 连接本地crawler服务
       crawleServiceURL := "http://localhost:8080/api/v1/scrape"

       if strings.HasPrefix(targetURL, "/static-file") {
           // 静态文件仍然指向服务器
           targetURL = "https://10.211.55.9:2443" + targetURL
       }
   ```

**方案B**: 连接服务器Crawler服务（备用）

如果本地Crawler服务启动有问题，可以连接服务器：
```go
// 修改 backend/usecase/crawler.go
crawleServiceURL := "http://10.211.55.9:8081/api/v1/scrape"
```

#### 功能恢复
修复后以下功能正常工作：
- ✅ URL导入文档
- ✅ 批量网页抓取
- ✅ 内容自动提取
- ✅ Markdown格式转换

## 完整启动流程

### 1. 环境准备
```bash
# 安装必要工具
brew install go node pnpm

# 验证安装
go version
node --version
pnpm --version
```

### 2. 后端启动
```bash
cd backend

# 安装依赖
go mod tidy

# 生成代码
go generate ./...

# 创建必要目录
mkdir -p data/ssl

# 启动API服务（终端1）
go run cmd/api/main.go cmd/api/wire_gen.go

# 启动Consumer服务（终端2）
go run cmd/consumer/main.go

# 启动Crawler服务（终端3）
go run cmd/crawler/main.go
```

### 3. 前端启动
```bash
# 管理后台（新终端）
cd web/admin
pnpm install
pnpm dev

# 用户前台（新终端）
cd web/app  
pnpm install
pnpm dev
```

### 4. 访问地址
- **管理后台**: http://localhost:5173
- **用户前台**: http://localhost:3010
- **后端API**: http://localhost:8000
- **Crawler服务**: http://localhost:8080

### 5. 登录信息
- **用户名**: admin
- **密码**: WHp1wNa0BAD0aPAvXtJlRnDj9b8miCWJ

## 本地开发限制

### 功能限制
- ❌ 无法通过独立端口访问知识库
- ❌ 无法使用自定义域名
- ❌ 无法上传许可证

### 正常功能
- ✅ 知识库创建、编辑、删除
- ✅ 文档管理
- ✅ 用户管理
- ✅ 统计分析
- ✅ AI对话功能
- ✅ 网页爬虫和URL导入
- ✅ 文件上传和转换

## 故障排除

### 常用检查命令
```bash
# 检查服务器连接
ping 10.211.55.9

# 检查端口占用
lsof -i :8000  # API服务
lsof -i :8080  # Crawler服务
lsof -i :5173  # 管理后台
lsof -i :3010  # 用户前台

# 检查服务状态
curl http://localhost:8000     # API服务
curl http://localhost:8080     # Crawler服务

# 测试Crawler功能
curl -X POST http://localhost:8080/api/v1/scrape \
  -H "Content-Type: application/json" \
  -d '{"url":"https://www.baidu.com","kb_id":"test"}'

# 查看后端日志
# 在各个服务启动终端查看实时日志
```

### 重启服务
如果遇到问题，按以下顺序重启：
1. 停止所有服务（Ctrl+C）
2. 重新启动后端服务：
   - API服务 (端口8000)
   - Consumer服务
   - Crawler服务 (端口8080)
3. 重新启动前端服务：
   - 管理后台 (端口5173)
   - 用户前台 (端口3010)

## 快速启动脚本

为了简化启动过程，可以使用以下脚本：

### 一键启动脚本 (`start-local-dev.sh`)
```bash
#!/bin/bash
echo "🚀 启动 PandaWiki 本地开发环境"

# 检查服务器连接
if ! ping -c 1 10.211.55.9 > /dev/null 2>&1; then
    echo "❌ 无法连接到服务器 10.211.55.9"
    exit 1
fi

# 启动后端
cd backend
go run cmd/api/main.go cmd/api/wire_gen.go &
go run cmd/consumer/main.go &
go run cmd/crawler/main.go &

# 启动前端
cd ../web/admin && pnpm dev &
cd ../web/app && pnpm dev &

echo "✅ 所有服务已启动"
echo "管理后台: http://localhost:5173"
echo "用户前台: http://localhost:3010"
echo "后端API: http://localhost:8000"
echo "Crawler服务: http://localhost:8080"
```

### 仅前端启动脚本 (`start-frontend-only.sh`)
```bash
#!/bin/bash
echo "🚀 启动前端服务（连接服务器API）"

# 更新前端配置连接服务器
cd web/admin
sed -i '' 's/localhost:8000/10.211.55.9:8080/g' .env.local

cd ../app
sed -i '' 's/localhost:8000/10.211.55.9:8080/g' .env.local

# 启动前端
cd ../admin && pnpm dev &
cd ../app && pnpm dev &

echo "✅ 前端服务已启动，连接服务器API"
```

## 开发建议

### 代码修改最佳实践
1. **配置文件**: 使用环境变量覆盖，避免直接修改默认配置
2. **路径处理**: 使用相对路径，避免硬编码绝对路径
3. **服务依赖**: 添加服务可用性检查，优雅降级
4. **日志记录**: 区分开发和生产环境的日志级别

### 调试技巧
1. **后端调试**: 使用Go的调试工具或添加详细日志
2. **前端调试**: 使用浏览器开发者工具
3. **API测试**: 使用curl或Postman测试接口
4. **Crawler测试**: 使用curl测试网页抓取功能
5. **数据库查询**: 直接连接服务器数据库进行调试

### 性能优化
1. **热重载**: 前端支持热重载，后端需要手动重启
2. **依赖缓存**: pnpm和go mod会缓存依赖，加速后续启动
3. **并行启动**: 可以并行启动多个服务

## 常见错误代码

| 错误类型 | 状态码 | 解决方案 |
|---------|--------|----------|
| 连接被拒绝 | - | 检查服务器服务状态 |
| 404 Not Found | 404 | 检查路由配置或接口实现 |
| 401 Unauthorized | 401 | 检查JWT token或重新登录 |
| 500 Internal Server Error | 500 | 查看后端日志定位具体错误 |
| dial tcp: lookup xxx: no such host | - | 容器名解析失败，需要改为IP地址 |
| Caddy sync failed | - | 本地环境跳过Caddy同步 |
| License 404 | 404 | 注释前端license调用或实现handler |
| Crawler scrape failed | - | 修改crawler服务地址为服务器IP |
| kb_id is required | 200/400 | 缺少X-KB-ID header，需要Caddy注入或环境变量 |
| NEXT_REDIRECT to /auth/login | 307 | 路径不在白名单，添加到pathnameWhiteList |

## 版本兼容性

### Go版本要求
- **最低版本**: Go 1.21+
- **推荐版本**: Go 1.24.3+
- **验证命令**: `go version`

### Node.js版本要求
- **最低版本**: Node.js 18+
- **推荐版本**: Node.js 20+
- **包管理器**: pnpm (推荐) 或 npm

### 数据库兼容性
- **PostgreSQL**: 13+
- **Redis**: 6+
- **其他中间件**: 使用服务器版本

## 总结

本地开发环境通过以上配置修改，可以实现：
- ✅ 前端和后端代码的本地开发
- ✅ 连接服务器的数据库和中间件
- ✅ 大部分功能的正常使用
- ✅ 实时代码修改和调试

**功能限制**:
- ❌ 多端口知识库访问（需要Caddy动态路由）
- ❌ 自定义域名绑定（需要Caddy Header注入）
- ❌ 许可证管理（可选功能）
- ❌ 完整的KB_ID自动获取机制

**KB_ID机制说明**:
PandaWiki使用Caddy动态路由实现多知识库独立访问，通过自动Header注入(`X-KB-ID`)来识别知识库。本地开发环境缺少此机制，因此采用了跳过KB信息获取的方案。详细机制请参考《PandaWiki KB_ID机制详解.md》。

**适用场景**:
- ✅ 功能开发和测试
- ✅ Bug修复和调试
- ✅ 界面优化和改进
- ✅ API接口开发
- ✅ 网页爬虫功能测试
- ✅ 文档导入功能开发
- ✅ 完整的本地开发环境

## 服务架构总览

本地开发环境包含以下服务：

| 服务名称 | 端口 | 功能描述 | 状态 |
|---------|------|----------|------|
| **API服务** | 8000 | 主要业务逻辑API | ✅ 必需 |
| **Consumer服务** | - | 消息队列消费者 | ✅ 必需 |
| **Crawler服务** | 8080 | 网页抓取和文档转换 | ✅ 必需 |
| **管理后台** | 5173 | 管理界面 | ✅ 开发用 |
| **用户前台** | 3010 | 用户访问界面 | ✅ 开发用 |

对于日常开发工作，这个完整配置满足所有需求。生产部署时，所有功能都会正常工作。
