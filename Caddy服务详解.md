# PandaWiki ä¸­çš„ Caddy æœåŠ¡è¯¦è§£

## Caddy æ˜¯ä»€ä¹ˆï¼Ÿ

Caddy æ˜¯ä¸€ä¸ªç°ä»£åŒ–çš„ Web æœåŠ¡å™¨å’Œåå‘ä»£ç†æœåŠ¡å™¨ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š
- **è‡ªåŠ¨ HTTPS**: è‡ªåŠ¨è·å–å’Œç»­æœŸ SSL è¯ä¹¦
- **åŠ¨æ€é…ç½®**: æ”¯æŒ API åŠ¨æ€æ›´æ–°é…ç½®ï¼Œæ— éœ€é‡å¯
- **ç®€å•é…ç½®**: JSON æˆ– Caddyfile æ ¼å¼é…ç½®
- **é«˜æ€§èƒ½**: Go è¯­è¨€ç¼–å†™ï¼Œæ€§èƒ½ä¼˜å¼‚

## åœ¨ PandaWiki ä¸­çš„ä½œç”¨

### 1. å¤šçŸ¥è¯†åº“åŠ¨æ€è·¯ç”±ç½‘å…³

Caddy æ˜¯ PandaWiki çš„**æ ¸å¿ƒè·¯ç”±ç»„ä»¶**ï¼Œè´Ÿè´£å°†å¤–éƒ¨è¯·æ±‚æ™ºèƒ½è·¯ç”±åˆ°æ­£ç¡®çš„çŸ¥è¯†åº“åº”ç”¨ã€‚

```
ç”¨æˆ·è¯·æ±‚ â†’ Caddy (ç«¯å£/åŸŸåè¯†åˆ«) â†’ å¯¹åº”çš„çŸ¥è¯†åº“åº”ç”¨
```

### 2. çŸ¥è¯†åº“ç‹¬ç«‹è®¿é—®å…¥å£

æ¯ä¸ªçŸ¥è¯†åº“å¯ä»¥é…ç½®ç‹¬ç«‹çš„è®¿é—®æ–¹å¼ï¼š

#### ç«¯å£è®¿é—®
```
çŸ¥è¯†åº“A: http://your-server:8001
çŸ¥è¯†åº“B: http://your-server:8002  
çŸ¥è¯†åº“C: http://your-server:8003
```

#### åŸŸåè®¿é—®
```
çŸ¥è¯†åº“A: https://wiki-a.company.com
çŸ¥è¯†åº“B: https://wiki-b.company.com
çŸ¥è¯†åº“C: https://docs.company.com
```

#### SSLç«¯å£è®¿é—®
```
çŸ¥è¯†åº“A: https://your-server:8443
çŸ¥è¯†åº“B: https://your-server:8444
```

### 3. åŠ¨æ€é…ç½®ç®¡ç†

å½“ä½ åœ¨ç®¡ç†åå°åˆ›å»ºæˆ–ä¿®æ”¹çŸ¥è¯†åº“æ—¶ï¼Œç³»ç»Ÿä¼šï¼š

1. **è‡ªåŠ¨æ›´æ–° Caddy é…ç½®**: é€šè¿‡ Caddy Admin API åŠ¨æ€æ·»åŠ è·¯ç”±è§„åˆ™
2. **æ— éœ€é‡å¯æœåŠ¡**: é…ç½®ç«‹å³ç”Ÿæ•ˆ
3. **SSL è¯ä¹¦ç®¡ç†**: è‡ªåŠ¨å¤„ç†è‡ªå®šä¹‰åŸŸåçš„ SSL è¯ä¹¦

## æŠ€æœ¯å®ç°ç»†èŠ‚

### 1. Caddy Admin API é›†æˆ

PandaWiki é€šè¿‡ Unix Socket ä¸ Caddy é€šä¿¡ï¼š

```go
// backend/config/config.go
CaddyAPI: "/app/run/caddy-admin.sock"
```

### 2. åŠ¨æ€è·¯ç”±é…ç½®ç”Ÿæˆ

å½“åˆ›å»ºçŸ¥è¯†åº“æ—¶ï¼Œç³»ç»Ÿä¼šç”Ÿæˆç±»ä¼¼è¿™æ ·çš„ Caddy é…ç½®ï¼š

```json
{
  "apps": {
    "http": {
      "servers": {
        "server_8001": {
          "listen": [":8001"],
          "routes": [
            {
              "match": [{"path": ["/static-file/*"]}],
              "handle": [{
                "handler": "reverse_proxy",
                "upstreams": [{"dial": "panda-wiki-minio:9000"}]
              }]
            },
            {
              "match": [{"path": ["/*"]}],
              "handle": [
                {
                  "handler": "headers",
                  "request": {
                    "set": {"X-KB-ID": ["kb-uuid-here"]}
                  }
                },
                {
                  "handler": "reverse_proxy", 
                  "upstreams": [{"dial": "panda-wiki-app:3000"}]
                }
              ]
            }
          ]
        }
      }
    }
  }
}
```

### 3. è¯·æ±‚è·¯ç”±é€»è¾‘

```
å¤–éƒ¨è¯·æ±‚ â†’ Caddy â†’ è·¯ç”±åˆ¤æ–­ â†’ ç›®æ ‡æœåŠ¡
                    â†“
            æ ¹æ®ç«¯å£/åŸŸåè¯†åˆ«çŸ¥è¯†åº“
                    â†“
            æ·»åŠ  X-KB-ID è¯·æ±‚å¤´
                    â†“
            è½¬å‘åˆ° panda-wiki-app
```

## ä¸å…¶ä»–æœåŠ¡çš„å…³ç³»

### Caddy vs Nginx

| æœåŠ¡ | ä½œç”¨ | ç«¯å£ |
|------|------|------|
| **Caddy** | çŸ¥è¯†åº“å‰å°è·¯ç”±ç½‘å…³ | åŠ¨æ€ç«¯å£ (8001, 8002...) |
| **Nginx** | ç®¡ç†åå°åå‘ä»£ç† | 2443 |

- **Caddy**: å¤„ç†ç”¨æˆ·è®¿é—®çŸ¥è¯†åº“ç½‘ç«™çš„è¯·æ±‚
- **Nginx**: å¤„ç†ç®¡ç†å‘˜è®¿é—®æ§åˆ¶å°çš„è¯·æ±‚

### æœåŠ¡ä¾èµ–å…³ç³»

```
ç”¨æˆ·è®¿é—®çŸ¥è¯†åº“ â†’ Caddy â†’ panda-wiki-app (å‰å°)
ç®¡ç†å‘˜è®¿é—®æ§åˆ¶å° â†’ Nginx â†’ panda-wiki-admin (åå°)
APIè¯·æ±‚ â†’ Nginx â†’ panda-wiki-api (åç«¯)
```

## å¼€å‘ç¯å¢ƒä¸­çš„ Caddy

### æ˜¯å¦éœ€è¦ Caddyï¼Ÿ

åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒä¸­ï¼ŒCaddy çš„å¿…è¦æ€§å–å†³äºä½ çš„éœ€æ±‚ï¼š

#### ğŸŸ¢ **ä¸éœ€è¦ Caddy çš„æƒ…å†µ**
- åªå¼€å‘ç®¡ç†åå°åŠŸèƒ½
- åªæµ‹è¯• API æ¥å£
- å•çŸ¥è¯†åº“å¼€å‘æµ‹è¯•

#### ğŸŸ¡ **éœ€è¦ Caddy çš„æƒ…å†µ**
- æµ‹è¯•å¤šçŸ¥è¯†åº“è·¯ç”±
- æµ‹è¯•è‡ªå®šä¹‰åŸŸåè®¿é—®
- æµ‹è¯• SSL è¯ä¹¦åŠŸèƒ½
- å®Œæ•´çš„ç”¨æˆ·è®¿é—®æµç¨‹æµ‹è¯•

### æœ¬åœ°å¼€å‘é…ç½®

å¦‚æœéœ€è¦ Caddyï¼Œå¯ä»¥è¿™æ ·é…ç½®ï¼š

```yaml
# docker-compose.dev.yml ä¸­çš„ caddy æœåŠ¡
caddy:
  container_name: panda-wiki-caddy
  image: chaitin-registry.cn-hangzhou.cr.aliyuncs.com/chaitin/panda-wiki-caddy:2.10-alpine
  cap_add:
    - NET_ADMIN
  volumes:
    - ./data/caddy/caddy_config:/config
    - ./data/caddy/caddy_data:/data
    - ./data/caddy/run:/var/run/caddy
  environment:
    - CADDY_ADMIN=unix//var/run/caddy/caddy-admin.sock
  network_mode: host
```

### æœ¬åœ°æµ‹è¯•æµç¨‹

1. **å¯åŠ¨ Caddy**: `docker-compose -f docker-compose.dev.yml up -d caddy`
2. **å¯åŠ¨æœ¬åœ°æœåŠ¡**: API + å‰å°åº”ç”¨
3. **åˆ›å»ºçŸ¥è¯†åº“**: åœ¨ç®¡ç†åå°åˆ›å»ºçŸ¥è¯†åº“å¹¶é…ç½®ç«¯å£
4. **è®¿é—®æµ‹è¯•**: é€šè¿‡é…ç½®çš„ç«¯å£è®¿é—®çŸ¥è¯†åº“

## å¸¸è§é—®é¢˜

### 1. ç«¯å£å†²çª
å¦‚æœé…ç½®çš„ç«¯å£è¢«å ç”¨ï¼ŒCaddy ä¼šæŠ¥é”™ï¼ŒçŸ¥è¯†åº“åˆ›å»ºå¤±è´¥ã€‚

### 2. è¯ä¹¦é—®é¢˜
è‡ªå®šä¹‰åŸŸåéœ€è¦æœ‰æ•ˆçš„ SSL è¯ä¹¦ï¼Œå¦åˆ™ HTTPS è®¿é—®ä¼šå¤±è´¥ã€‚

### 3. ç½‘ç»œè®¿é—®
Caddy ä½¿ç”¨ `network_mode: host`ï¼Œç›´æ¥ä½¿ç”¨å®¿ä¸»æœºç½‘ç»œã€‚

## æ€»ç»“

Caddy åœ¨ PandaWiki ä¸­æ˜¯ä¸€ä¸ª**æ™ºèƒ½è·¯ç”±ç½‘å…³**ï¼Œå®ƒçš„æ ¸å¿ƒä»·å€¼åœ¨äºï¼š

âœ… **å¤šç§Ÿæˆ·æ”¯æŒ**: æ¯ä¸ªçŸ¥è¯†åº“ç‹¬ç«‹è®¿é—®å…¥å£  
âœ… **åŠ¨æ€é…ç½®**: æ— éœ€é‡å¯å³å¯æ·»åŠ æ–°è·¯ç”±  
âœ… **SSL ç®¡ç†**: è‡ªåŠ¨å¤„ç† HTTPS è¯ä¹¦  
âœ… **é«˜æ€§èƒ½**: é«˜å¹¶å‘è¯·æ±‚å¤„ç†èƒ½åŠ›  
âœ… **æ˜“ç»´æŠ¤**: é€šè¿‡ API è‡ªåŠ¨åŒ–ç®¡ç†é…ç½®  

å¯¹äºç”Ÿäº§ç¯å¢ƒï¼ŒCaddy æ˜¯å¿…éœ€çš„ï¼›å¯¹äºå¼€å‘ç¯å¢ƒï¼Œå¯ä»¥æ ¹æ®å…·ä½“éœ€æ±‚é€‰æ‹©æ˜¯å¦å¯ç”¨ã€‚
